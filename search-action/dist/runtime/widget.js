/*! For license information please see widget.js.LICENSE.txt */
System.register(["jimu-core","jimu-core/react-dom","jimu-core/react"],(function(e,t){var o={},r={},n={};return{setters:[function(e){o.DataSourceComponent=e.DataSourceComponent,o.MessageManager=e.MessageManager,o.StringSelectionChangeMessage=e.StringSelectionChangeMessage,o.jsx=e.jsx},function(e){r.default=e.default},function(e){n.createElement=e.createElement,n.forwardRef=e.forwardRef,n.useEffect=e.useEffect,n.useRef=e.useRef,n.useState=e.useState}],execute:function(){e((()=>{var e={8891:e=>{"use strict";e.exports=o},1315:e=>{"use strict";e.exports=n},800:e=>{"use strict";e.exports=r}},t={};function l(o){var r=t[o];if(void 0!==r)return r.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,l),n.exports}l.d=(e,t)=>{for(var o in t)l.o(t,o)&&!l.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.p="";var i={};return l.p=window.jimuConfig.baseUrl,(()=>{"use strict";l.r(i),l.d(i,{__set_webpack_public_path__:()=>C,default:()=>y});var e=l(8891),t=l(800),o=l(1315);const r=e=>{const t=(e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,((e,t,o)=>o?o.toUpperCase():t.toLowerCase())))(e);return t.charAt(0).toUpperCase()+t.slice(1)},n=(...e)=>e.filter(((e,t,o)=>Boolean(e)&&""!==e.trim()&&o.indexOf(e)===t)).join(" ").trim(),a=e=>{for(const t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const u=(0,o.forwardRef)((({color:e="currentColor",size:t=24,strokeWidth:r=2,absoluteStrokeWidth:l,className:i="",children:u,iconNode:c,...d},f)=>(0,o.createElement)("svg",{ref:f,...s,width:t,height:t,stroke:e,strokeWidth:l?24*Number(r)/Number(t):r,className:n("lucide",i),...!u&&!a(d)&&{"aria-hidden":"true"},...d},[...c.map((([e,t])=>(0,o.createElement)(e,t))),...Array.isArray(u)?u:[u]]))),c=((e,t)=>{const l=(0,o.forwardRef)((({className:l,...i},a)=>{return(0,o.createElement)(u,{ref:a,iconNode:t,className:n(`lucide-${s=r(e),s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${e}`,l),...i});var s}));return l.displayName=r(e),l})("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]);var d=function(e,t,o,r){return new(o||(o=Promise))((function(n,l){function i(e){try{s(r.next(e))}catch(e){l(e)}}function a(e){try{s(r.throw(e))}catch(e){l(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}s((r=r.apply(e,t||[])).next())}))};const f={SELECTED_YEAR:"selected-year",SELECTED_DAM:"selected_dam"};function m(e){return localStorage.getItem(e)}function g(e,t){t?localStorage.setItem(e,t):localStorage.removeItem(e)}function p(e,t){const o=function(e){switch(e){case"ru":default:return"title_ru";case"uz":return"title_uz_l";case"uzcryl":return"title_uz_c"}}(t),r=e.getFieldValue(o);return r&&""!==r.trim()?r:e.getFieldValue("dam_name")||"Unknown"}function v(){try{const e=localStorage.getItem("exb_auth");if(e)try{const t=JSON.parse(e);if(t.email)return t.email;if(t.user&&t.user.email)return t.user.email;if(t.username&&t.username.includes("@"))return t.username}catch(e){}const t=Object.keys(localStorage).filter((e=>e.includes("portalApp")||e.includes("portal")||e.includes("token")||e.includes("credential")));for(const e of t)try{const t=localStorage.getItem(e),o=JSON.parse(t||"{}");if(o.email)return o.email}catch(e){continue}const o=Object.keys(localStorage);for(const e of o)try{const t=localStorage.getItem(e);if(t&&(t.includes('"email"')||t.includes("farhodmf")||t.includes("@"))){const e=JSON.parse(t);if(e.email)return e.email}}catch(t){const o=localStorage.getItem(e);if(o&&o.includes("@")&&o.length<100)return o;continue}return null}catch(e){return console.error("🔐 Search widget: Error extracting user email:",e),null}}function h(e,t){if(!t||!e)return!1;const o=e.getFieldValue("allowed_users");return!!o&&o.split(",").map((e=>e.trim().toLowerCase())).includes(t.toLowerCase())}function w(e,t){return t?e.filter((e=>h(e,t))):[]}function E(e,t,o){return o&&"All"!==o&&t?e.filter((e=>{const r=e.getFieldValue(t);return r&&r.toString()===o})):e}function S(){return"dark"===localStorage.getItem("customTheme")?"dark":"light"}function x(e,t){var o,r;return e&&"object"==typeof e&&(e.light||e.dark)?null!==(r=null!==(o=e[t])&&void 0!==o?o:e.light)&&void 0!==r?r:e.dark:e}function y(r){var n,l,i,a,s,u,y,C,b,_,I;const[T,D]=(0,o.useState)(),[A,k]=(0,o.useState)([]),[L,z]=(0,o.useState)([]),[j,M]=(0,o.useState)([]),[R,F]=(0,o.useState)(""),[N,O]=(0,o.useState)([]),[B,W]=(0,o.useState)(!1),[$,P]=(0,o.useState)(-1),[V,Y]=(0,o.useState)({left:0,top:0,width:0}),[U,q]=(0,o.useState)(null),[K,H]=(0,o.useState)("ru"),[J,G]=(0,o.useState)(!1),[Z,Q]=(0,o.useState)(null),[X,ee]=(0,o.useState)(!0),te=(0,o.useRef)(null),oe=(0,o.useRef)(null),re=(0,o.useRef)(null),[ne,le]=(0,o.useState)(S()),[ie,ae]=(0,o.useState)(0),se=null===(n=r.useDataSources)||void 0===n?void 0:n[0],ue=r.config,ce=ue.damField||"dam_name",de="made_year",fe=ue.placeholder||("ru"===K?"Введите название водохранилища":"uz"===K?"Suv omborining nomini kiriting":"Сув омборининг номини киритинг"),[me,ge]=(0,o.useState)(!1),[pe,ve]=(0,o.useState)(!1);(0,o.useEffect)((()=>{!function(){d(this,void 0,void 0,(function*(){ee(!0);try{const e=yield function(){return d(this,arguments,void 0,(function*(e=3,t=1e3){let o=v();if(o)return o;for(let r=1;r<=e;r++)if(yield new Promise((e=>setTimeout(e,t))),o=v(),o)return o;return null}))}(3,1e3);Q(e)}catch(e){console.error("🔐 Search widget: Authentication error:",e),Q(null)}finally{ee(!1)}}))}()}),[]),(0,o.useEffect)((()=>{if(Z||X)return;const e=setInterval((()=>{const t=v();t&&(Q(t),clearInterval(e))}),2e3),t=setTimeout((()=>{clearInterval(e)}),3e4);return()=>{clearInterval(e),clearTimeout(t)}}),[Z,X]),(0,o.useEffect)((()=>{q(m(f.SELECTED_YEAR)||"All"),H(m("custom_locale")||"ru")}),[]);const he=e=>{var t;return null!==(t=x(e,ne))&&void 0!==t?t:"#e5e7eb"},we=(e,t)=>{var o,r,n;return e?null!==(o=x(ue.dropdownActiveIconColor,ne))&&void 0!==o?o:"#2264e5":t?null!==(r=x(ue.dropdownActiveIconColor,ne))&&void 0!==r?r:"#2264e5":null!==(n=x(ue.dropdownIconColor,ne))&&void 0!==n?n:"#181923"},Ee=e=>{const t=e||"All";t!==U&&(q(t),(e&&"All"!==e||!U||"All"===U)&&e!==U&&(q(e),R&&e&&"All"!==e&&A.length>0&&setTimeout((()=>{const t=w(E(A,de,e),Z),o=Array.from(new Set(t.map((e=>e.getFieldValue(ce))).filter(Boolean))),r=m(f.SELECTED_DAM);o.length>0&&r&&!o.includes(r)&&(F(""),g(f.SELECTED_DAM,null))}),100)))};(0,o.useEffect)((()=>{const e=m(f.SELECTED_YEAR),t=m("custom_locale")||"ru";m(f.SELECTED_DAM),q(e&&"All"!==e?e:null),H(t)}),[]),(0,o.useEffect)((()=>{let e,t,o;function r(e){switch(e.key){case f.SELECTED_YEAR:Ee(e.newValue);break;case f.SELECTED_DAM:break;case"custom_locale":H(e.newValue||"ru")}}return window.addEventListener("storage",r),e=setInterval((()=>{const e=m(f.SELECTED_YEAR);e!==U&&Ee(e)}),100),t=setInterval((()=>{m(f.SELECTED_DAM)}),100),o=setInterval((()=>{const e=m("custom_locale")||"ru";e!==K&&H(e)}),100),()=>{window.removeEventListener("storage",r),clearInterval(e),clearInterval(t),clearInterval(o),re.current&&clearTimeout(re.current)}}),[U,R,K,J,A,de,ce,Z]),(0,o.useEffect)((()=>{T&&Z&&!X&&Se()}),[T,Z,X]),(0,o.useEffect)((()=>{if(!Z)return void z([]);const e=E(w(A,Z),de,U);z(e)}),[A,U,Z,de]),(0,o.useEffect)((()=>{if(L.length>0){const e=new Map;L.forEach((t=>{const o=t.getFieldValue(ce),r=p(t,K);o&&!e.has(o)&&e.set(o,{damName:o,localizedTitle:r})}));const t=Array.from(e.values()).sort(((e,t)=>e.localizedTitle.localeCompare(t.localizedTitle)));M(t)}else M([])}),[L,ce,U,K]),(0,o.useEffect)((()=>{if(R.trim()){const e=R.trim().toLowerCase(),t=j.filter((t=>t.damName.toLowerCase().includes(e)||t.localizedTitle.toLowerCase().includes(e)));O(t)}else O([]);P(-1)}),[R,j]);const Se=()=>d(this,void 0,void 0,(function*(){if(T&&r.id&&Z)try{const e={where:"1=1",outFields:[ce,de,"title_ru","title_uz_c","title_uz_l","allowed_users",...ue.localField?[ue.localField]:[]],returnGeometry:!0},t=(yield T.query(e,{widgetId:r.id})).records||[],o=function(e){if(!e)return"1=0";const t=e.toLowerCase();return`(\n    LOWER(allowed_users) LIKE '${t},%' OR \n    LOWER(allowed_users) LIKE '%,${t},%' OR \n    LOWER(allowed_users) LIKE '%,${t}' OR \n    LOWER(allowed_users) = '${t}'\n  )`}(Z),n={where:o,outFields:[ce,de,"title_ru","title_uz_c","title_uz_l","allowed_users",...ue.localField?[ue.localField]:[]],returnGeometry:!0};(yield T.query(n,{widgetId:r.id})).records;const l=t.filter((e=>h(e,Z)));k(l)}catch(e){console.error("❌ Search widget: Load failed:",e)}}));function xe(t){G(!1),re.current&&clearTimeout(re.current),F(t.localizedTitle),W(!1),P(-1),console.log("damItem",t.damName),g(f.SELECTED_DAM,t.damName||null);const o=new e.StringSelectionChangeMessage(r.id,t.damName);o.str=t.damName,e.MessageManager.getInstance().publishMessage(o)}if((0,o.useEffect)((()=>{if(B)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){oe.current&&!oe.current.contains(e.target)&&W(!1)}}),[B]),(0,o.useEffect)((()=>{let e=S();const t=e=>{if("customTheme"===e.key){const e=S();le(e),ae((e=>e+1))}};window.addEventListener("storage",t);const o=setInterval((()=>{const t=S();t!==e&&(e=t,le(t),ae((e=>e+1)))}),300);return()=>{window.removeEventListener("storage",t),clearInterval(o)}}),[]),(0,o.useEffect)((()=>{const e=m(f.SELECTED_DAM);if(e&&j.length>0&&!J){const t=j.find((t=>t.damName===e));F(t?t.localizedTitle:e)}else e||J||F("")}),[j,J]),(0,o.useEffect)((()=>{const e=setInterval((()=>{const e=m(f.SELECTED_DAM);if(e&&j.length>0&&!J){const t=j.find((t=>t.damName===e));t&&t.localizedTitle!==R&&F(t.localizedTitle)}else e||!R||J||F("")}),200);return()=>clearInterval(e)}),[j,R,J]),(0,o.useEffect)((()=>{const e=m(f.SELECTED_DAM);if(e&&j.length>0&&!J){const t=j.find((t=>t.damName===e));t&&t.localizedTitle!==R&&F(t.localizedTitle)}}),[K,j,J]),(0,o.useEffect)((()=>{const e=m(f.SELECTED_DAM);if(e&&A.length>0&&!J){const t=A.find((t=>t.getFieldValue(ce)===e));if(t){const e=p(t,K);e!==R&&F(e)}}}),[K,A,ce,J]),X)return(0,e.jsx)("div",{ref:oe,style:{width:"100%",height:"100%",position:"relative",background:null!==(l=x(ue.bgColor,ne))&&void 0!==l?l:"#fff",borderRadius:ue.borderRadius||"16px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"20px",textAlign:"center",color:null!==(i=x(ue.textColor,ne))&&void 0!==i?i:"#181923",fontSize:ue.fontSize||"14px",border:`1.5px solid ${null!==(a=x(ue.borderColor,ne))&&void 0!==a?a:"#e5e7eb"}`}},(0,e.jsx)("div",null,(0,e.jsx)("p",{style:{margin:"0 0 8px 0",fontWeight:600}},"ru"===K?"Проверка авторизации...":"uz"===K?"Avtorizatsiya tekshirilmoqda...":"Авторизация текширилмоқда..."),(0,e.jsx)("small",{style:{opacity:.7}},"ru"===K?"Пожалуйста, подождите":"uz"===K?"Iltimos kuting":"Илтимос кутинг")));if(!Z)return(0,e.jsx)("div",{ref:oe,style:{width:"100%",height:"100%",position:"relative",background:null!==(s=x(ue.bgColor,ne))&&void 0!==s?s:"#fff",borderRadius:ue.borderRadius||"16px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"20px",textAlign:"center",color:null!==(u=x(ue.textColor,ne))&&void 0!==u?u:"#181923",fontSize:ue.fontSize||"14px",border:`1.5px solid ${null!==(y=x(ue.borderColor,ne))&&void 0!==y?y:"#e5e7eb"}`}},(0,e.jsx)("div",null,(0,e.jsx)("p",{style:{margin:"0 0 8px 0",fontWeight:600}},"ru"===K?"Пользователь не авторизован":"uz"===K?"Foydalanuvchi avtorizatsiya qilinmagan":"Фойдаланувчи авторизация қилинмаган"),(0,e.jsx)("small",{style:{opacity:.7}},"ru"===K?"Войдите для поиска":"uz"===K?"Qidiruv uchun kiring":"Қидириш учун киринг")));const ye=B&&N.length>0&&t.default.createPortal((0,e.jsx)("div",{style:{position:"fixed",left:V.left,top:V.top,width:V.width,background:null!==(C=x(ue.dropdownItemBgColor,ne))&&void 0!==C?C:"#fff",borderRadius:ue.borderRadius||"12px",zIndex:9999,marginTop:"8px",maxHeight:220,overflowY:"auto",overflowX:"hidden"},onMouseDown:e=>e.stopPropagation()},N.map(((t,o)=>{var r,n,l,i,a,s;const u=$===o,d=t.localizedTitle===R,f=u?null!==(r=x(ue.dropdownItemHoverTextColor,ne))&&void 0!==r?r:"#2264e5":d?null!==(n=x(ue.dropdownItemActiveTextColor,ne))&&void 0!==n?n:"#2264e5":null!==(l=x(ue.dropdownItemTextColor,ne))&&void 0!==l?l:"#181923",m=u?null!==(i=x(ue.dropdownItemHoverBgColor,ne))&&void 0!==i?i:"#F2F7FF":d?null!==(a=x(ue.dropdownItemActiveBgColor,ne))&&void 0!==a?a:"#F2F7FF":null!==(s=x(ue.dropdownItemBgColor,ne))&&void 0!==s?s:"#fff";return(0,e.jsx)("div",{key:t.damName,style:{display:"flex",alignItems:"center",textAlign:"left",cursor:"pointer",fontSize:ue.dropdownItemFontSize||"16px",padding:ue.dropdownItemPadding||"12px 16px",borderRadius:ue.dropdownItemBorderRadius||"8px",margin:"0 8px",fontWeight:400,background:m,color:f,border:"1.5px solid transparent",transition:"background 0.15s, color 0.15s, border 0.15s"},onMouseEnter:()=>P(o),onMouseDown:e=>e.stopPropagation(),onClick:()=>xe(t)},(0,e.jsx)(c,{size:20,style:{marginRight:10,color:we(u,d)}}),(0,e.jsx)("span",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},t.localizedTitle))}))),document.body);return(0,e.jsx)("div",{ref:oe,style:{width:"100%",height:"100%",position:"relative",borderRadius:ue.borderRadius||"16px",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"stretch"}},(0,e.jsx)(e.DataSourceComponent,{useDataSource:se,widgetId:r.id,onDataSourceCreated:e=>D(e)}),(0,e.jsx)("div",{ref:oe,style:{width:"100%",display:"flex",alignItems:"center",border:`1.5px solid ${pe||R.trim().length>0?he(ue.activeBorderColor):he(me?ue.hoverBorderColor:ue.defaultBorderColor||ue.borderColor)}`,borderRadius:ue.borderRadius||"16px",background:null!==(b=x(ue.bgColor,ne))&&void 0!==b?b:"#fff",padding:ue.padding||"0 18px",position:"relative",boxSizing:"border-box",opacity:Z?1:.6},onMouseEnter:()=>ge(!0),onMouseLeave:()=>ge(!1),onFocus:()=>ve(!0),onBlur:()=>ve(!1),onClick:()=>{var e;return null===(e=te.current)||void 0===e?void 0:e.focus()}},(0,e.jsx)(c,{size:20,style:{marginRight:10,color:(()=>{var e;return null!==(e=x(R.trim().length>0?ue.activeIconColor:ue.iconColor,ne))&&void 0!==e?e:"#181923"})()}}),(0,e.jsx)("div",{style:{width:"100%",height:"100%"}},(0,e.jsx)("style",null,`\n              .custom-placeholder::placeholder {\n                color: ${null!==(_=x(ue.placeholderColor,ne))&&void 0!==_?_:"black"};\n                opacity: 1;\n              }\n            `),(0,e.jsx)("input",{ref:te,className:"custom-placeholder",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:null!==(I=x(ue.textColor,ne))&&void 0!==I?I:"#181923",fontSize:ue.fontSize||"16px",fontWeight:ue.fontWeight||400,padding:"14px 0"},value:R,placeholder:fe,disabled:!Z,onChange:t=>{G(!0),re.current&&clearTimeout(re.current),F(t.target.value),t.target.value.trim()?W(!0):W(!1),t.target.value.trim()||function(){G(!1),re.current&&clearTimeout(re.current),F(""),g(f.SELECTED_DAM,null);const t=new e.StringSelectionChangeMessage(r.id,"");t.str="",e.MessageManager.getInstance().publishMessage(t)}(),re.current=setTimeout((()=>{G(!1)}),500)},onFocus:function(){if(oe.current){const e=oe.current.getBoundingClientRect();Y({left:e.left,top:e.bottom+window.scrollY,width:e.width})}R.trim()&&N.length>0?W(!0):W(!1),P(-1)},onBlur:()=>setTimeout((()=>W(!1)),180),onKeyDown:function(e){B&&0!==N.length&&("ArrowDown"===e.key?(e.preventDefault(),P((e=>Math.min(e+1,N.length-1)))):"ArrowUp"===e.key?(e.preventDefault(),P((e=>Math.max(e-1,0)))):"Enter"===e.key?(e.preventDefault(),$>=0&&N[$]?xe(N[$]):1===N.length&&xe(N[0])):"Escape"===e.key&&W(!1))},autoComplete:"off"}))),ye)}function C(e){l.p=e}})(),i})())}}}));